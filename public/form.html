<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Flight - Saudia Travel Fair</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./config.js"></script>
    <style>
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Regular.otf') format('opentype');
        font-weight: 400;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Bold.otf') format('opentype');
        font-weight: 700;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Light.otf') format('opentype');
        font-weight: 300;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Medium.otf') format('opentype');
        font-weight: 500;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-SemiBold.otf') format('opentype');
        font-weight: 600;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-ExtraBold.otf') format('opentype');
        font-weight: 800;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Black.otf') format('opentype');
        font-weight: 900;
        font-style: normal;
      }
      
      body {
        font-family: 'SaudiaSans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'saudia-green': '#006400',
                        'saudia-light-green': '#228B22',
                        'saudia-blue': '#87CEEB',
                        'saudia-light-blue': '#98FB98'
                    },
                    fontFamily: {
                        'saudia': ['SaudiaSans', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body
    class="min-h-screen flex flex-col items-center justify-center text-saudia-green relative overflow-hidden p-5"
    style="
      background-image: url('./assets/bg.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    "
  >
  <img src="./assets/decoration.png" class="h-[20svh] absolute top-0 left-0 "/>
  <img src="./assets/decoration.png" class="h-[20svh] absolute bottom-0 right-0 rotate-180" />
  
  <img src="./assets/logo.svg" class="h-[8svh] mb-[4svh]" />

  <!-- Game Title and Start Screen -->
  <div
    id="startScreen"
    class="text-center h-[70svh] bg-white w-fit min-w-[40svw] flex flex-col justify-center items-center w-fit relative z-20 rounded-lg p-[3svh]"
  >

        <form id="contactForm" class="w-full text-left flex flex-col">
            
        <div class="text-center mb-[4svh]">
            <h1 class="text-[3svh] font-bold bg-gradient-to-r from-saudia-green to-saudia-light-green bg-clip-text text-transparent">‚úàÔ∏è Masukkan Informasi Anda</h1>
        </div>
            <div class="mb-[2svh]">
                <label for="nama" class="block text-sm font-semibold  text-saudia-green mb-1">Nama</label>
                <input type="text" id="nama" name="nama" placeholder="Masukkan nama lengkap" required 
                       class="w-full px-2 py-2 border-2 border-saudia-green/30 rounded-xl bg-white/90 text-saudia-green placeholder-saudia-green/60 focus:outline-none focus:border-saudia-green/60 focus:bg-white focus:shadow-lg focus:shadow-saudia-green/20 transition-all duration-300">
            </div>

            <div class="mb-[2svh]">
                <label for="email" class="block text-sm font-semibold mb-1 text-saudia-green">Email</label>
                <input type="email" id="email" name="email" placeholder="Masukkan alamat email" required 
                       class="w-full px-2 py-2 border-2 border-saudia-green/30 rounded-xl bg-white/90 text-saudia-green placeholder-saudia-green/60 focus:outline-none focus:border-saudia-green/60 focus:bg-white focus:shadow-lg focus:shadow-saudia-green/20 transition-all duration-300">
            </div>

            <div class="mb-[2svh]">
                <label for="whatsapp" class="block text-sm font-semibold mb-1 text-saudia-green">No. WhatsApp</label>
                <input type="tel" id="whatsapp" name="whatsapp" placeholder="Masukkan nomor WhatsApp" required 
                       class="w-full px-2 py-2 border-2 border-saudia-green/30 rounded-xl bg-white/90 text-saudia-green placeholder-saudia-green/60 focus:outline-none focus:border-saudia-green/60 focus:bg-white focus:shadow-lg focus:shadow-saudia-green/20 transition-all duration-300">
            </div>

            <div class="mb-[2svh]">
                <label class="block text-sm font-semibold mb-2 text-saudia-green">Jenis Kelamin</label>
                <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="gender" value="male" required 
                               class="w-4 h-4 text-saudia-green bg-white border-2 border-saudia-green/30 focus:ring-saudia-green/20 focus:ring-2 transition-all duration-300">
                        <span class="ml-2 text-sm font-medium text-saudia-green">Laki-laki</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="gender" value="female" required 
                               class="w-4 h-4 text-saudia-green bg-white border-2 border-saudia-green/30 focus:ring-saudia-green/20 focus:ring-2 transition-all duration-300">
                        <span class="ml-2 text-sm font-medium text-saudia-green">Perempuan</span>
                    </label>
                </div>
            </div>

            <button type="submit" class="w-full bg-gradient-to-r from-saudia-green to-saudia-light-green text-white py-[1svh] mt-[2svh] px-6 rounded-xl text-lg font-bold cursor-pointer transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:shadow-saudia-green/30 border-2 border-saudia-green/30 active:translate-y-0">Submit</button>
        </form>

        <div class="text-[2.4svh] hidden px-[3svh]" id="successMessage" >
          Form berhasil disubmit!<br/> Anda akan dialihkan ke game dalam beberapa detik...
        </div>
        


        <div id="gameOverScreen" class="hidden flex flex-col bg-white rounded-lg p-[4svh] border border-saudia-green/20">
            <h2 class="text-[3svh] font-bold text-saudia-green mb-6">
                üéâ Game Selesai!
              </h2>
              <div class="text-[2.4svh] text-saudia-green">
                Skor Anda: <span id="finalScore" class="font-bold">0</span>/18
              </div>
              <div class="text-[2.4svh] text-saudia-green mb-6">
                Waktu Tersisa: <span id="gameDuration" class="font-bold">0</span> detik
              </div>
              <p class="text-[2svh] text-saudia-green/70 mb-6">
                Silakan main lagi dalam beberapa jam.
              </p>
        </div>

    </div>

    <script>
        // WebSocket connection - automatically detect protocol
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);
        
        // State management
        let formData = null;
        let isPlaying = false;
        
        ws.onopen = function() {
            console.log('WebSocket connected from form page');
            console.log('WebSocket readyState:', ws.readyState);
        };
        
        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            if (message.type === 'form-submitted') {
                console.log('Form submitted via WebSocket:', message.data);
            } else if (message.type === 'game-over') {
                console.log('Game over detected via WebSocket:', message.data);
                // Reset playing state immediately when game over is received
                isPlaying = false;
                console.log('isPlaying reset to false from game-over message');
                showGameOverScreen(message.data);
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function() {
            console.log('WebSocket disconnected');
        };
        
        document.getElementById('contactForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Check if user is already playing
            if (isPlaying) {
                console.log('Form submission blocked: User is already playing');
                return;
            }
            
            // Get form data
            const formDataObj = new FormData(this);
            formData = Object.fromEntries(formDataObj);
            
            try {
                // Initialize Supabase client
                const supabaseClient = supabase.createClient(config.supabaseUrl, config.supabaseKey);
                
                                 // Submit form data to Supabase (using existing table structure)
                 const { data, error } = await supabaseClient
                     .from('saudia')
                     .insert([
                         {
                             name: formData.nama,
                             email: formData.email,
                             whatsapp: formData.whatsapp,
                             gender: formData.gender,
                             "time-remaining": "0",
                             score: "0"
                         }
                     ]);
                
                if (error) {
                    console.error('Error submitting to Supabase:', error);
                    alert('Terjadi kesalahan saat mengirim data. Silakan coba lagi.');
                    return;
                }
                
                console.log('Data submitted to Supabase successfully:', data);
                
                // Set isPlaying to true
                isPlaying = true;
                
                // Form data stored in memory for current session
                console.log('Form data stored in memory:', formData);
                
                // Send form data via WebSocket
                if (ws && ws.readyState === WebSocket.OPEN) {
                    const messageToSend = JSON.stringify({
                        type: 'form-submitted',
                        data: formData
                    });
                    console.log('Sending WebSocket message:', messageToSend);
                    ws.send(messageToSend);
                    console.log('Form data sent via WebSocket:', formData);
                    console.log('isPlaying set to:', isPlaying);
                } else {
                    console.error('WebSocket not ready. State:', ws.readyState);
                }
                
                // Update form UI to disabled state first
                updateFormUI();
                
                // Show success message
                const successMessage = document.getElementById('successMessage');
                successMessage.classList.remove('hidden');
                
                // Form submitted successfully - no redirect needed
                
            } catch (error) {
                console.error('Error in form submission:', error);
                alert('Terjadi kesalahan saat mengirim data. Silakan coba lagi.');
            }
        });
        
        // Function to update form UI based on playing state
        function updateFormUI() {
            const form = document.getElementById('contactForm');
            const submitButton = form.querySelector('button[type="submit"]');
            const inputs = form.querySelectorAll('input');
            
            if (isPlaying) {
                // Disable form when playing
                submitButton.disabled = true;
                submitButton.textContent = 'Sedang Bermain...';
                submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                
                inputs.forEach(input => {
                    input.disabled = true;
                    input.classList.add('opacity-50', 'cursor-not-allowed');
                });
                
                console.log('Form disabled: User is playing');
            } else {
                // Enable form when not playing
                submitButton.disabled = false;
                submitButton.textContent = 'Submit';
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                
                inputs.forEach(input => {
                    input.disabled = false;
                    input.classList.remove('opacity-50', 'cursor-not-allowed');
                });
                
                console.log('Form enabled: User can submit');
            }
        }
        
        // Function to show game over screen
        function showGameOverScreen(gameData) {
            // Reset playing state
            isPlaying = false;
            console.log('Game over: isPlaying reset to false');
            
            // Clear form data since game is over
            formData = null;
            
            // Hide the form and success message
            const form = document.getElementById('contactForm');
            const successMessage = document.getElementById('successMessage');
            form.classList.add('hidden');
            successMessage.classList.add('hidden');
            
            // Update game over screen with actual data
            document.getElementById('finalScore').textContent = gameData.score;
            document.getElementById('gameDuration').textContent = gameData.remainingTime;
            
            // Show game over screen
            const gameOverScreen = document.getElementById('gameOverScreen');
            gameOverScreen.classList.remove('hidden');
            
            // No automatic redirect - user stays on the form page
        }
        

        
        // Initialize form UI on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Form starts in enabled state since no localStorage data
            console.log('Form initialized in enabled state');
        });
    </script>
</body>
</html>
