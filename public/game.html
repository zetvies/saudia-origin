<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Saudia Quiz Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Regular.otf') format('opentype');
        font-weight: 400;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Bold.otf') format('opentype');
        font-weight: 700;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Light.otf') format('opentype');
        font-weight: 300;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Medium.otf') format('opentype');
        font-weight: 500;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-SemiBold.otf') format('opentype');
        font-weight: 600;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-ExtraBold.otf') format('opentype');
        font-weight: 800;
        font-style: normal;
      }
      @font-face {
        font-family: 'SaudiaSans';
        src: url('./assets/font/SaudiaSans-Black.otf') format('opentype');
        font-weight: 900;
        font-style: normal;
      }
      
      body {
        font-family: 'SaudiaSans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }
    </style>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "saudia-green": "#006400",
              "saudia-light-green": "#228B22",
              "saudia-blue": "#87CEEB",
              "saudia-light-blue": "#98FB98",
            },
            fontFamily: {
              'saudia': ['SaudiaSans', 'sans-serif'],
            },
          },
        },
      };
    </script>
  </head>
  <body
    class="min-h-screen flex flex-col items-center py-[4svh] text-saudia-green relative overflow-hidden p-5"
    style="
      background-image: url('./assets/bg.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    "
  >
    <img
      src="./assets/decoration.png"
      class="h-[20svh] absolute top-0 left-0"
    />
    <img src="./assets/logo.svg" class="h-[12svh] mb-[4svh]" />

    <!-- Game Title and Start Screen -->
    <div
      id="startScreen"
      class="text-center h-[70svh] flex flex-col justify-center items-center w-full relative z-20"
    >
      <h1 class="text-4xl md:text-5xl font-bold mb-[2svh]">Saudia Quiz Game</h1>
      <p class="text-lg">
        Complete the city image by finding the missing piece!
      </p>
      <button
        id="startBtn"
        class="mt-[8svh] bg-saudia-green text-white px-8 py-4 rounded-2xl text-xl font-bold hover:shadow-lg transition-all duration-300 hover:-translate-y-1"
      >
        Mulai Game
      </button>
    </div>

    <!-- Countdown Screen -->
    <div
      id="countdownScreen"
      class="hidden text-center h-[70svh] flex flex-col justify-center items-center w-full relative z-20 mt-[2svh]"
    >
      <h2
        class="text-[4svh] font-bold text-saudia-green mb-[2svh]"
        id="countdownTitle"
      >
        Get Ready!
      </h2>
      <div
        id="countdownTimer"
        class="text-[8svh] mb-[8svh] font-bold text-saudia-green"
      >
        3
      </div>
      <div id="loadingProgress" class="hidden mt-4">
        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
          <div
            id="progressBar"
            class="bg-saudia-green h-2 rounded-full transition-all duration-300"
            style="width: 0%"
          ></div>
        </div>
        <p class="text-sm text-saudia-green/70">Loading game assets...</p>
      </div>
    </div>

    <!-- Game Screen -->
    <div
      id="gameScreen"
      class="hidden text-center h-[70svh] flex flex-col justify-center items-center w-full relative z-20 mt-[2svh]"
    >
      <!-- Header -->
      <div
        class="flex justify-between items-center p-[2svh] bg-saudia-green/10 h-fit bg-white rounded-lg w-[50svh] text-[2svh]"
      >
        <div class="font-bold text-saudia-green">
          Level: <span id="currentLevel">1</span>/6
        </div>
        <div class="font-bold text-saudia-green">
          Score: <span id="score">0</span>
        </div>
        <div class="font-bold text-saudia-green">
          Time: <span id="gameTimer">60</span>s
        </div>
      </div>

      <!-- 4x4 Grid -->
      <div
        class="grid grid-cols-4 grid-rows-4 h-[40svh] w-[40svh] bg-white/80 rounded-lg mt-[2svh]"
      >
        <!-- Grid cells will be generated here -->
      </div>

      <div
        class="p-[1svh] w-[50svh] bg-white/80 border border-saudia-green/20 rounded-lg mt-4"
      >
        <div id="answersContainer" class="grid grid-cols-4 gap-1 justify-center">
          <!-- Draggable answers will be generated here -->
        </div>
      </div>
    </div>

    <!-- Game Over Screen -->
    <div
      id="gameOverScreen"
      class="hidden text-center h-[70svh] flex flex-col justify-center items-center w-full relative z-20 mt-[2svh]"
    >
      <div
        class="flex flex-col bg-white rounded-lg p-[4svh] border border-saudia-green/20"
      >
        <h2 class="text-[3svh] font-bold text-saudia-green mb-6">
          üéâ Game Selesai!
        </h2>
        <div class="text-[2.4svh] text-saudia-green">
          Skor Anda: <span id="finalScore" class="font-bold">0</span>/18
        </div>
        <div class="text-[2.4svh] text-saudia-green mb-6">
          Waktu Tersisa:
          <span id="gameDuration" class="font-bold">0</span> detik
        </div>
        <p class="text-[2svh] text-saudia-green/70">
          Kembali ke halaman utama dalam
          <span id="redirectTimer">5</span> detik...
        </p>
      </div>
    </div>

    <script>
      // WebSocket connection
      const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);
      
      ws.onopen = function() {
        console.log("WebSocket connected from game page");
      };
      
      ws.onerror = function(error) {
        console.error("WebSocket error:", error);
      };
      
      ws.onclose = function() {
        console.log("WebSocket disconnected from game page");
      };

      // Game state
      let gameState = "start"; // start, countdown, playing, gameOver
      let currentLevel = 1;
      let score = 0;
      let gameStartTime = 0;
      let totalTimeUsed = 0;
      let countdownInterval;
      let gameTimerInterval;
      let redirectInterval;
      let selectedCity = "";
      let missingPositions = []; // Array of 3 missing grid positions
      let missingImages = []; // Array of 3 missing image names
      let usedCities = []; // Track used cities to ensure uniqueness
      let completedPiecesCount = 0; // Simple counter for completed pieces

      // Available cities
      const cities = [
        "Amsterdam-300w",
        "Barcelona-300w",
        "Cairo-300w",
        "Frankfurt-300w",
        "London-300w",
        "Madrid-300w",
        "Milan-300w",
        "Paris-300w",
        "Rome-300w",
        "Turkey-300w",
        "Washington-300w",
      ];

      // DOM elements
      const startScreen = document.getElementById("startScreen");
      const countdownScreen = document.getElementById("countdownScreen");
      const gameScreen = document.getElementById("gameScreen");
      const gameOverScreen = document.getElementById("gameOverScreen");
      const startBtn = document.getElementById("startBtn");
      const countdownTimer = document.getElementById("countdownTimer");
      const currentLevelSpan = document.getElementById("currentLevel");
      const scoreSpan = document.getElementById("score");
      const gameTimerSpan = document.getElementById("gameTimer");
      const finalScore = document.getElementById("finalScore");
      const gameDuration = document.getElementById("gameDuration");
      const redirectTimer = document.getElementById("redirectTimer");

      // Utility function to shuffle array
      function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
      }

      // Drag and drop functions
      let draggedElement = null;

      function handleDragStart(e) {
        draggedElement = e.target;
        e.target.style.opacity = "0.5";
        e.dataTransfer.effectAllowed = "move";
      }

      function handleDragEnd(e) {
        e.target.style.opacity = "1";
        draggedElement = null;
      }

      // Event listeners
      startBtn.addEventListener("click", startGame);

      // Game functions
      function startGame() {
        gameState = "countdown";
        startScreen.classList.add("hidden");
        countdownScreen.classList.remove("hidden");

        let countdown = 3;
        countdownTimer.textContent = countdown;

        countdownInterval = setInterval(() => {
          countdown--;
          countdownTimer.textContent = countdown;

          if (countdown <= 0) {
            clearInterval(countdownInterval);
            startPlaying();
          }
        }, 1000);
      }

      function startPlaying() {
        gameState = "playing";
        countdownScreen.classList.add("hidden");
        gameScreen.classList.remove("hidden");

        gameStartTime = Date.now();
        currentLevel = 1;
        score = 0;
        totalTimeUsed = 0;
        usedCities = [];
        missingPositions = [];
        missingImages = [];
        completedPiecesCount = 0;
        scoreSpan.textContent = score;

        initGame();
        startGameTimer();
      }

      // Clear game state for next level
      function clearGameState() {
        console.log("=== CLEARING GAME STATE ===");
        
        // Clear any completed pieces
        const completedPieces = document.querySelectorAll('.missing-piece[data-completed="true"]');
        completedPieces.forEach(piece => {
          delete piece.dataset.completed;
        });
        
        // Clear arrays and counter
        missingPositions = [];
        missingImages = [];
        completedPiecesCount = 0;
        
        console.log("Arrays cleared:", { missingPositions, missingImages, completedPiecesCount });
        console.log("Game state cleared for next level");
      }

      // Initialize game
      function initGame() {
        console.log("=== INITIALIZING GAME LEVEL", currentLevel, "===");
        
        // Clear any previous state
        missingPositions = [];
        missingImages = [];
        completedPiecesCount = 0;

        // Randomly select one city for the complete image
        selectedCity = getRandomCity();
        console.log("Selected city:", selectedCity);

        // Generate the 4x4 grid with three missing pieces
        generateGrid();
        console.log("Grid generated. Missing positions:", missingPositions);
        console.log("Grid generated. Missing images:", missingImages);

        // Generate 8 answer options (3 correct + 5 wrong)
        generateAnswers();
        console.log("Answers generated");

        // Setup drop zones for missing pieces
        setTimeout(setupDropZone, 100);
      }

      // Get random city (ensuring uniqueness)
      function getRandomCity() {
        // Filter out cities that have already been used
        const availableCities = cities.filter(
          (city) => !usedCities.includes(city)
        );

        if (availableCities.length === 0) {
          // If all cities have been used, reset the used cities array
          usedCities = [];
          return cities[Math.floor(Math.random() * cities.length)];
        }

        // Select a random city from available ones
        const selectedCity =
          availableCities[Math.floor(Math.random() * availableCities.length)];
        usedCities.push(selectedCity);
        return selectedCity;
      }

      // Generate 4x4 grid with three missing pieces
      function generateGrid() {
        console.log("=== GENERATE GRID START ===");
        console.log("Current missingPositions:", missingPositions);
        console.log("Current missingImages:", missingImages);
        
        const gridContainer = document.querySelector(".grid");
        gridContainer.innerHTML = "";

        // Randomly select 3 different positions for missing pieces (A1 to A16)
        missingPositions = [];
        missingImages = [];
        
        while (missingPositions.length < 3) {
          const randomPosition = Math.floor(Math.random() * 16);
          if (!missingPositions.includes(randomPosition)) {
            missingPositions.push(randomPosition);
            const imageNumber = randomPosition + 1; // A1, A2, A3, ..., A16
            const imageName = `${selectedCity.split("-")[0]}A${imageNumber}.png`;
            missingImages.push(imageName);
          }
        }

        console.log("=== GRID GENERATION DEBUG ===");
        console.log("Missing positions selected:", missingPositions);
        console.log("Missing images selected:", missingImages);
        console.log("Arrays after population:", { missingPositions, missingImages });

        // Create 4x4 grid showing A1 to A16 images
        for (let i = 0; i < 16; i++) {
          const cell = document.createElement("div");
          cell.className =
            "bg-gray-100 flex items-center justify-center relative overflow-hidden min-h-0 min-w-0";
          cell.id = `cell-${i}`;

          if (missingPositions.includes(i)) {
            // This is a missing piece - make it a drop zone
            cell.classList.add("bg-white");
            cell.classList.add("missing-piece");
            cell.dataset.missingIndex = i; // Store the actual grid position (0-15)
            cell.innerHTML =
              '<span class="text-saudia-green/50 text-[1.5svh] pointer-events-none select-none">Drag and <br/>Drop here</span>';
            
            console.log(`Created missing piece at position ${i} with dataset:`, cell.dataset);
          } else {
            // Show the corresponding A1-A16 image
            const imageNumber = i + 1; // A1, A2, A3, ..., A16
            const imageName = `${
              selectedCity.split("-")[0]
            }A${imageNumber}.png`;

            cell.innerHTML = `<img src="assets/cities/${selectedCity}/${imageName}" alt="City ${imageNumber}" class="w-full h-full object-cover">`;
          }

          gridContainer.appendChild(cell);
        }
        
        console.log("=== GENERATE GRID END ===");
        console.log("Final missingPositions:", missingPositions);
        console.log("Final missingImages:", missingImages);
      }

      // Generate 8 answer options (3 correct + 5 wrong)
      function generateAnswers() {
        console.log("=== GENERATE ANSWERS START ===");
        console.log("Generating answers for city:", selectedCity);
        console.log("Missing images:", missingImages);
        console.log("Missing positions:", missingPositions);
        console.log("Arrays at start of generateAnswers:", { missingPositions, missingImages });

        const answersContainer = document.getElementById("answersContainer");
        console.log("Answers container:", answersContainer);
        answersContainer.innerHTML = "";

        // Create 3 correct answers (the missing pieces)
        // Ensure each answer is mapped to its correct missing position
        for (let i = 0; i < missingPositions.length; i++) {
          const gridPosition = missingPositions[i];
          const imageName = missingImages[i];
          
          console.log(`Creating correct answer ${i}:`, { gridPosition, imageName });
          
          const correctAnswer = createDraggableAnswer(
            selectedCity,
            imageName,
            true,
            gridPosition // Store the actual grid position (0-15)
          );
          console.log("Correct answer created:", {
            index: i,
            gridPosition: gridPosition,
            imageName: imageName,
            element: correctAnswer,
            dataset: correctAnswer.dataset
          });
          answersContainer.appendChild(correctAnswer);
        }

        // Create 5 wrong answers from other cities
        const wrongCities = cities.filter((city) => city !== selectedCity);

        // Ensure we have enough different cities (need at least 5)
        if (wrongCities.length < 5) {
          console.warn(
            "Not enough different cities available, some wrong answers may repeat"
          );
        }

        const selectedWrongCities = getRandomCities(5, wrongCities);
        console.log("Wrong cities selected:", selectedWrongCities);

        selectedWrongCities.forEach((city) => {
          // Double-check that this city is different from the question city
          if (city === selectedCity) {
            console.error("Wrong answer city matches question city!", city);
            return; // Skip this wrong answer
          }

          const randomImage = getRandomImage(city);
          const wrongAnswer = createDraggableAnswer(city, randomImage, false, -1);
          console.log("Wrong answer created for", city, ":", wrongAnswer);
          answersContainer.appendChild(wrongAnswer);
        });

        console.log(
          "Total answers in container:",
          answersContainer.children.length
        );
        console.log("=== GENERATE ANSWERS END ===");
      }

      // Get random cities for wrong answers
      function getRandomCities(count, availableCities = cities) {
        const shuffled = [...availableCities].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, count);
      }

      // Get random image from city folder
      function getRandomImage(cityFolder) {
        const imageNumbers = Array.from({ length: 16 }, (_, i) => i + 1);
        const randomNum =
          imageNumbers[Math.floor(Math.random() * imageNumbers.length)];
        return `${cityFolder.split("-")[0]}A${randomNum}.png`;
      }

      // Create draggable answer element
      function createDraggableAnswer(city, imageName, isCorrect, index) {
        const answerDiv = document.createElement("div");
        answerDiv.className =
          "w-[10svh] h-[10svh] bg-white border-2 border-saudia-green/30 rounded-lg cursor-grab active:cursor-grabbing flex items-center justify-center overflow-hidden";
        answerDiv.draggable = true;
        answerDiv.dataset.city = city;
        answerDiv.dataset.image = imageName;
        answerDiv.dataset.correct = isCorrect;
        answerDiv.dataset.index = index; // Add index for correct answers

        answerDiv.innerHTML = `<img src="assets/cities/${city}/${imageName}" alt="City" class="w-full h-full object-cover pointer-events-none">`;

        // Add drag events
        answerDiv.addEventListener("dragstart", handleDragStart);
        answerDiv.addEventListener("dragend", handleDragEnd);

        return answerDiv;
      }

      // Add drop zone functionality to answer grid
      function setupDropZone() {
        const missingPieces = document.querySelectorAll(".missing-piece");
        missingPieces.forEach((piece) => {
          piece.addEventListener("dragover", handleDragOver);
          piece.addEventListener("drop", handleDrop);
        });
      }

      function handleDragOver(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
        e.target.style.borderColor = "rgb(0, 100, 0, 0.6)";
        e.target.style.backgroundColor = "rgb(0, 100, 0, 0.2)";
      }

      function handleDrop(e) {
        e.preventDefault();

        if (draggedElement) {
          const isCorrect = draggedElement.dataset.correct === "true";
          const answerGridPosition = parseInt(draggedElement.dataset.index);

          console.log("=== DROP EVENT DEBUG ===");
          console.log("Dragged element dataset:", draggedElement.dataset);
          console.log("Target element dataset:", e.target.dataset);
          console.log("Is correct answer:", isCorrect);
          console.log("Answer grid position:", answerGridPosition);
          console.log("Answer grid position type:", typeof answerGridPosition);

          if (isCorrect) {
            // Check if this is the correct missing piece for this position
            const targetGridPosition = parseInt(e.target.dataset.missingIndex);
            
            console.log("=== MATCHING DEBUG ===");
            console.log("Target grid position:", targetGridPosition);
            console.log("Target grid position type:", typeof targetGridPosition);
            console.log("Missing positions array:", missingPositions);
            console.log("Missing images array:", missingImages);
            console.log("Comparison result:", answerGridPosition === targetGridPosition);
            console.log("Answer position in missing positions:", missingPositions.includes(answerGridPosition));
            
            if (answerGridPosition === targetGridPosition) {
              // Correct answer for this specific missing piece
              console.log("‚úÖ CORRECT MATCH! Filling position:", targetGridPosition);
              score++;
              scoreSpan.textContent = score;

              // Show the correct piece immediately to complete the image
              const correctCity = draggedElement.dataset.city;
              const correctImage = draggedElement.dataset.image;

              // Preserve the cell structure and only update the content
              e.target.innerHTML = `<img src="assets/cities/${correctCity}/${correctImage}" alt="City piece" class="w-full h-full object-cover">`;

              // Remove the drop zone styling and make it look like a regular cell
              e.target.classList.remove("bg-white");
              e.target.classList.add("bg-gray-100");

              // Mark this piece as completed instead of removing from arrays
              e.target.dataset.completed = "true";

              // Disable the used answer element
              draggedElement.draggable = false;
              draggedElement.style.cursor = "not-allowed";
              draggedElement.style.opacity = "0.6";
              draggedElement.classList.remove("cursor-grab", "active:cursor-grabbing");
              draggedElement.classList.add("cursor-not-allowed");

              // Count completed pieces
              completedPiecesCount++;
              
              console.log(`Completed pieces: ${completedPiecesCount}/${missingPositions.length}`);

              // Check if all missing pieces are filled
              if (completedPiecesCount === missingPositions.length) {
                console.log("üéâ All pieces filled! Moving to next level");
                // All pieces filled - disable all answers and go to next level
                const answers = document.querySelectorAll(
                  "#answersContainer > div"
                );
                answers.forEach((answer) => {
                  answer.draggable = false;
                  answer.style.cursor = "not-allowed";
                  answer.style.opacity = "0.6";
                });

                // Wait 1 second then go to next level
                setTimeout(() => {
                  currentLevel++;
                  clearInterval(gameTimerInterval);
                  if (currentLevel > 6) {
                    endGame();
                  } else {
                    currentLevelSpan.textContent = currentLevel;
                    clearGameState(); // Clear state before next level
                    initGame();
                    startGameTimer();
                  }
                }, 1000);
              }
            } else {
              // Wrong missing piece for this position
              console.log("‚ùå WRONG PIECE for this position:", {
                answerGridPosition,
                targetGridPosition,
                difference: answerGridPosition - targetGridPosition
              });
              e.target.style.borderColor = "rgb(220, 38, 38, 0.8)";
              e.target.style.backgroundColor = "rgb(220, 38, 38, 0.2)";
              e.target.innerHTML =
                '<span class="text-red-600 text-lg font-bold">‚ùå Wrong piece!</span>';

              // Reset after 1 second
              setTimeout(() => {
                e.target.style.borderColor = "rgb(0, 100, 0, 0.3)";
                e.target.style.backgroundColor = "rgb(0, 100, 0, 0.05)";
                e.target.innerHTML =
                  '<span class="text-saudia-green/50 text-[1.5svh] pointer-events-none select-none">Drag and <br/>Drop here</span>';
              }, 1000);
            }
          } else {
            // Wrong answer
            console.log("‚ùå WRONG ANSWER dropped");
            e.target.style.borderColor = "rgb(220, 38, 38, 0.8)";
            e.target.style.backgroundColor = "rgb(220, 38, 38, 0.2)";
            e.target.innerHTML =
              '<span class="text-red-600 text-lg font-bold">‚ùå Wrong!</span>';

            // Reset after 1 second
            setTimeout(() => {
              e.target.style.borderColor = "rgb(0, 100, 0, 0.3)";
              e.target.style.backgroundColor = "rgb(0, 100, 0, 0.05)";
              e.target.innerHTML =
                '<span class="text-saudia-green/50 text-[1.5svh] pointer-events-none select-none">Drag and <br/>Drop here</span>';
            }, 1000);
          }
        }
      }

      // Restart game
      function restartGame() {
        score = 0;
        currentLevel = 1;
        totalTimeUsed = 0;
        usedCities = [];
        missingPositions = [];
        missingImages = [];
        completedPiecesCount = 0;
        scoreSpan.textContent = score;
        currentLevelSpan.textContent = currentLevel;
        gameTimerSpan.textContent = "60";
        
        // Clear any existing game state
        const gameScreen = document.getElementById("gameScreen");
        if (gameScreen) {
          gameScreen.classList.add("hidden");
        }
        
        // Reset to start screen
        const startScreen = document.getElementById("startScreen");
        if (startScreen) {
          startScreen.classList.remove("hidden");
        }
        
        // Reset game state
        gameState = "start";
      }

      // Timer functions
      function startGameTimer() {
        // Calculate remaining time from total 60 seconds
        let timeLeft = 60 - totalTimeUsed;
        gameTimerSpan.textContent = timeLeft;

        gameTimerInterval = setInterval(() => {
          timeLeft--;
          totalTimeUsed++;
          gameTimerSpan.textContent = timeLeft;

          if (timeLeft <= 0) {
            clearInterval(gameTimerInterval);
            handleTimeout();
          }
        }, 1000);
      }

      function handleTimeout() {
        // When timeout occurs, the remaining time becomes 0, so totalTimeUsed becomes 60
        totalTimeUsed = 60;
        endGame();
      }

      function endGame() {
        gameState = "gameOver";
        gameScreen.classList.add("hidden");
        gameOverScreen.classList.remove("hidden");

        // Calculate remaining time from total 60 seconds
        const remainingTime = 60 - totalTimeUsed;

        finalScore.textContent = score;
        gameDuration.textContent = remainingTime;

        // Send WebSocket signal to form.html
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'game-over',
            data: {
              score: score,
              remainingTime: remainingTime,
              level: currentLevel
            }
          }));
        }

        // Redirect after 5 seconds
        let redirectCountdown = 5;
        redirectTimer.textContent = redirectCountdown;

        redirectInterval = setInterval(() => {
          redirectCountdown--;
          redirectTimer.textContent = redirectCountdown;

          if (redirectCountdown <= 0) {
            clearInterval(redirectInterval);
            window.location.href = "/";
          }
        }, 1000);
      }

      // Start game when page loads
      document.addEventListener("DOMContentLoaded", () => {
        // Game will start when start button is clicked
      });
    </script>
  </body>
</html>
